<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Abdul Rafay‚Äôs Adventures</title>
  <link rel="icon" type="image/png" href="./favicon.png">
  <meta name="theme-color" content="#2e0249">
  <meta property="og:title" content="Abdul Rafay‚Äôs Adventures">
  <meta property="og:description" content="Live chat with me!">
  <meta property="og:image" content="https://www.rafaytravelsworldwide.com//link-to-a-cool-photo.jpg">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    * { box-sizing: border-box; }
    /* General Layout */
    .chat-portal { display: flex; flex-direction: column; height: 100%; position: relative; }
    .view-container { max-width: 1100px; margin: 0 auto; }
    
    /* Messages Area */
    #messages { 
      flex-grow: 1; 
      height: 600px !important; 
      max-height: 60vh; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      padding: 15px; 
      background: rgba(0,0,0,0.05); 
      margin-bottom: 0;
    }

    /* Buttons & Icons */
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; border-radius: 50%; }
    .icon-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
    .icon-btn svg { width: 24px; height: 24px; fill: var(--accent); }
    
    /* Emoji Bar */
    .emoji-bar {
       display: flex;
       justify-content: space-between;
       padding: 8px 15px;
       background: rgba(0,0,0,0.05);
       width: 100%;
       border-top: 1px solid rgba(0,0,0,0.1);
       border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .emoji-item { cursor: pointer; font-size: 1.2rem; transition: transform 0.1s; }
    .emoji-item:hover { transform: scale(1.3); }

    /* Staging Area */
    #stagingArea {
        display: none; 
        background: #f0f4f8;
        border-top: 2px solid var(--accent);
        padding: 10px 15px;
        align-items: center;
        justify-content: space-between;
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .staging-content { display: flex; align-items: center; gap: 10px; color: #333; font-weight: 600; font-size: 0.9rem; }
    .staging-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #ddd; border-radius: 4px; }
    .staging-preview-img { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }
    
    .close-staging-btn {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }

    /* Message Styles */
    .voice-msg { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); padding: 8px; border-radius: 12px; margin-top: 5px; width: 100%; max-width: 260px; }
    .voice-msg audio { width: 100%; height: 35px; min-width: 200px; filter: invert(10%) hue-rotate(250deg) brightness(1.2); }
    .chat-img { max-width: 250px; border-radius: 8px; margin-top: 5px; border: 2px solid white; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .doc-link { display: inline-flex; align-items: center; gap: 8px; padding: 10px; background: white; color: #333; text-decoration: none; border-radius: 8px; margin-top: 5px; font-size: 0.85rem; border: 1px solid #ddd; }
    .seen-indicator { font-size: 0.65rem; color: #777; display: block; margin-top: 4px; font-style: italic; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 2px; }
    
    /* Recording State */
    .recording-active { animation: pulse-red 1.5s infinite; background: rgba(255,0,0,0.1) !important; }
    .recording-active svg { fill: #ff4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); } }

    /* Icon Logic */
    #voiceBtn .stop-icon { display: none; }
    #voiceBtn.recording-active .mic-icon { display: none; }
    #voiceBtn.recording-active .stop-icon { display: block; }

    /* Spinner */
    #uploadSpinner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: 'Nunito', sans-serif; }
    .spinner-circle { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent, #9d4edd); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Input Area */
    .input-area {
        display: flex; 
        padding: 12px; 
        gap: 8px; 
        background: rgba(0,0,0,0.2); 
        align-items: center; 
        position: relative;
        z-index: 2;
    }

    @media (max-width: 768px) {
      body { margin: 0; padding: 0; overflow-x: hidden; width: 100vw; position: relative; }
      .top-wrapper { flex-direction: column !important; align-items: center; gap: 10px; padding: 10px; width: 100%; }
      .top-info { width: 95%; text-align: center; }
      .view-container { width: 100% !important; padding: 0 !important; margin: 0 !important; overflow-x: hidden; }
      .card { margin: 8px !important; width: calc(100% - 16px) !important; display: flex !important; flex-direction: column !important; border-radius: 12px; overflow: hidden; }
      .image-panel { width: 100% !important; order: 2; padding: 10px; }
      .image-panel img { width: 100%; height: auto; border-radius: 10px; }
      .content { width: 100% !important; order: 1; padding: 0 !important; }
      #messages { height: 400px !important; padding: 10px !important; width: 100%; overflow-x: hidden; }
      .msg { max-width: 85% !important; font-size: 0.85rem !important; margin-bottom: 8px !important; word-wrap: break-word; overflow-wrap: break-word; }
      .chat-btn { padding: 8px 10px !important; min-width: 60px; }
      .chat-input { font-size: 16px !important; flex: 1; min-width: 0; padding: 8px !important; }
      .chat-header h1 { font-size: 1.2rem !important; text-align: center; padding: 10px; }
      .voice-msg { max-width: 100%; }
      .voice-msg audio { min-width: 160px; width: 100%; }
      .input-area { padding: 8px !important; gap: 4px !important; width: 100%; overflow: hidden; }
    }
  </style>
</head>
<body>

  <div id="uploadSpinner">
    <div class="spinner-circle"></div>
    <span>Sending file...</span>
  </div>

  <button id="hamburgerBtn" class="hamburger">&#9776;</button>
  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="slide-menu" id="slideMenu">
    <button class="close-menu" id="closeMenuBtn">&times;</button>
    <a href="index.html" class="menu-item">Home</a>
    <a href="stories.html" class="menu-item">My Stories</a>
    <a href="learning.html" class="menu-item">Fun Learning</a>
    <a href="videos.html" class="menu-item">My Videos</a>
    <a href="chat.html" class="menu-item">Chat</a>
    <a href="about.html" class="menu-item">About Me</a>
  </div>
  <div class="flags-bar"><div class="flags-track" id="flagsTrack"></div></div>

  <div class="top-wrapper" style="display:flex; justify-content: space-around;">
    <div class="top-info">
      <span class="location-text">Where I now live</span>
      <div class="region"><img src="https://flagcdn.com/w20/gb.png" alt="UK Flag"></div>
      <div id="time-uk"></div><div id="date-uk"></div><div id="weather-uk">Loading‚Ä¶</div>
    </div>
    <div class="top-info">
      <span class="location-text">Where I came from</span>
      <div class="region"><img src="https://flagcdn.com/w20/pk.png" alt="Pakistan Flag"></div>
      <div id="time-pk"></div><div id="date-pk"></div><div id="weather-pk">Loading‚Ä¶</div>
    </div>
  </div>

  <div class="view-container">
    <div class="card" id="mainCard">
      <div class="content">
        <div class="chat-header">
            <h1 style="margin:0; color:var(--accent);">Chat with Yum right now!</h1>
            <button id="adminDelete" class="delete-btn" style="display:none;" onclick="clearHistory()">Clear History</button>
        </div>
        <div class="chat-portal">
          <div id="chatNameSection">
            <input type="text" id="userName" class="chat-input" placeholder="Your name...">
            <button class="chat-btn" onclick="startChat()" style="margin-top:10px; width:100%;">Join Chat Room</button>
          </div>
          <div id="chatBox">
            <div id="onlineStatus" class="online-indicator" style="display:none;">Online: <span id="userList">...</span></div>
            <div id="messages"></div>

            <div class="emoji-bar">
                <span class="emoji-item" onclick="pressEmoji('üòä')">üòä</span>
                <span class="emoji-item" onclick="pressEmoji('üòÇ')">üòÇ</span>
                <span class="emoji-item" onclick="pressEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="emoji-item" onclick="pressEmoji('üëç')">üëç</span>
                <span class="emoji-item" onclick="pressEmoji('üî•')">üî•</span>
                <span class="emoji-item" onclick="pressEmoji('‚ú®')">‚ú®</span>
                <span class="emoji-item" onclick="pressEmoji('üôå')">üôå</span>
                <span class="emoji-item" onclick="pressEmoji('üíØ')">üíØ</span>
                <span class="emoji-item" onclick="pressEmoji('üòé')">üòé</span>
                <span class="emoji-item" onclick="pressEmoji('üéâ')">üéâ</span>
                <span class="emoji-item" onclick="pressEmoji('üç¶')">üç¶</span>
                <span class="emoji-item" onclick="pressEmoji('üçï')">üçï</span>
                <span class="emoji-item" onclick="pressEmoji('üéà')">üéà</span>
                <span class="emoji-item" onclick="pressEmoji('‚≠ê')">‚≠ê</span>
            </div>

            <div id="stagingArea">
                <div class="staging-content" id="stagingContent"></div>
                <button class="close-staging-btn" onclick="clearStaged()" title="Remove attachment">√ó</button>
            </div>

            <div class="input-area">
              <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach File">
                <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.66 1.34 3 3 3s3-1.34 3-3V5c0-2.48-2.02-4.5-4.5-4.5S7 2.52 7 5v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
              </button>
              <input type="file" id="fileInput" style="display:none;" onchange="stageFile(this)">
              
              <button id="voiceBtn" class="icon-btn" onclick="toggleRecording()" title="Record Voice">
                <svg class="mic-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                <svg class="stop-icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
              </button>
              
              <input type="text" id="chatInput" class="chat-input" placeholder="Type a message...">
              <button id="sendBtn" class="chat-btn" onclick="handleSendClick()">Send</button>
            </div>
          </div>
        </div>
      </div>
      <div class="image-panel"><img src="./20250809_120138.jpg" style="max-width:100%;"></div>
    </div>
  </div>

  <audio id="sendSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    /* UI Functions (Time, Weather, Menu) - UNTOUCHED */
    const hamburgerBtn = document.getElementById('hamburgerBtn'); const closeMenuBtn = document.getElementById('closeMenuBtn'); const slideMenu = document.getElementById('slideMenu'); const menuOverlay = document.getElementById('menuOverlay'); function toggleMenu() { slideMenu.classList.toggle('open'); menuOverlay.classList.toggle('active'); } hamburgerBtn.addEventListener('click', toggleMenu); closeMenuBtn.addEventListener('click', toggleMenu); menuOverlay.addEventListener('click', toggleMenu);
    const countries = [{code:"af",name:"Afghanistan"},{code:"ax",name:"√Öland Islands"},{code:"al",name:"Albania"},{code:"dz",name:"Algeria"},{code:"as",name:"American Samoa"},{code:"ad",name:"Andorra"},{code:"ao",name:"Angola"},{code:"ai",name:"Anguilla"},{code:"aq",name:"Antarctica"},{code:"ag",name:"Antigua & Barbuda"},{code:"ar",name:"Argentina"},{code:"am",name:"Armenia"},{code:"aw",name:"Aruba"},{code:"au",name:"Australia"},{code:"at",name:"Austria"},{code:"az",name:"Azerbaijan"},{code:"bs",name:"Bahamas"},{code:"bh",name:"Bahrain"},{code:"bd",name:"Bangladesh"},{code:"bb",name:"Barbados"},{code:"by",name:"Belarus"},{code:"be",name:"Belgium"},{code:"bz",name:"Belize"},{code:"bj",name:"Benin"},{code:"bm",name:"Bermuda"},{code:"bt",name:"Bhutan"},{code:"bo",name:"Bolivia"},{code:"ba",name:"Bosnia & Herzegovina"},{code:"bw",name:"Botswana"},{code:"bv",name:"Bouvet Island"},{code:"br",name:"Brazil"},{code:"io",name:"Brit. Indian Ocean"},{code:"bn",name:"Brunei"},{code:"bg",name:"Bulgaria"},{code:"bf",name:"Burkina Faso"},{code:"bi",name:"Burundi"},{code:"kh",name:"Cambodia"},{code:"cm",name:"Cameroon"},{code:"ca",name:"Canada"},{code:"cv",name:"Cape Verde"},{code:"bq",name:"Caribbean NL"},{code:"ky",name:"Cayman Islands"},{code:"cf",name:"Central African Rep."},{code:"td",name:"Chad"},{code:"cl",name:"Chile"},{code:"cn",name:"China"},{code:"cx",name:"Christmas Island"},{code:"cc",name:"Cocos (Keeling)"},{code:"co",name:"Colombia"},{code:"km",name:"Comoros"},{code:"cg",name:"Congo (Rep.)"},{code:"cd",name:"Congo (DRC)"},{code:"ck",name:"Cook Islands"},{code:"cr",name:"Costa Rica"},{code:"ci",name:"C√¥te d‚ÄôIvoire"},{code:"hr",name:"Croatia"},{code:"cu",name:"Cuba"},{code:"cw",name:"Cura√ßao"},{code:"cy",name:"Cyprus"},{code:"cz",name:"Czechia"},{code:"dk",name:"Denmark"},{code:"dj",name:"Djibouti"},{code:"dm",name:"Dominica"},{code:"do",name:"Dominican Republic"},{code:"ec",name:"Ecuador"},{code:"eg",name:"Egypt"},{code:"sv",name:"El Salvador"},{code:"gq",name:"Equatorial Guinea"},{code:"er",name:"Eritrea"},{code:"ee",name:"Estonia"},{code:"sz",name:"Eswatini"},{code:"et",name:"Ethiopia"},{code:"fk",name:"Falkland Islands"},{code:"fo",name:"Faroe Islands"},{code:"fj",name:"Fiji"},{code:"fi",name:"Finland"},{code:"fr",name:"France"},{code:"gf",name:"French Guiana"},{code:"pf",name:"French Polynesia"},{code:"tf",name:"French S. Terr."},{code:"ga",name:"Gabon"},{code:"gm",name:"Gambia"},{code:"ge",name:"Georgia"},{code:"de",name:"Germany"},{code:"gh",name:"Ghana"},{code:"gi",name:"Gibraltar"},{code:"gr",name:"Greece"},{code:"gl",name:"Greenland"},{code:"gd",name:"Grenada"},{code:"gp",name:"Guadeloupe"},{code:"gu",name:"Guam"},{code:"gt",name:"Guatemala"},{code:"gg",name:"Guernsey"},{code:"gn",name:"Guinea"},{code:"gw",name:"Guinea-Bissau"},{code:"gy",name:"Guyana"},{code:"ht",name:"Haiti"},{code:"hm",name:"Heard & McDonald"},{code:"va",name:"Vatican City"},{code:"hn",name:"Honduras"},{code:"hk",name:"Hong Kong"},{code:"hu",name:"Hungary"},{code:"is",name:"Iceland"},{code:"in",name:"India"},{code:"id",name:"Indonesia"},{code:"ir",name:"Iran"},{code:"iq",name:"Iraq"},{code:"ie",name:"Ireland"},{code:"im",name:"Isle of Man"},{code:"il",name:"Israel"},{code:"it",name:"Italy"},{code:"jm",name:"Jamaica"},{code:"jp",name:"Japan"},{code:"je",name:"Jersey"},{code:"jo",name:"Jordan"},{code:"kz",name:"Kazakhstan"},{code:"ke",name:"Kenya"},{code:"ki",name:"Kiribati"},{code:"kp",name:"North Korea"},{code:"kr",name:"South Korea"},{code:"kw",name:"Kuwait"},{code:"kg",name:"Kyrgyzstan"},{code:"la",name:"Laos"},{code:"lv",name:"Latvia"},{code:"lb",name:"Lebanon"},{code:"ls",name:"Lesotho"},{code:"lr",name:"Liberia"},{code:"ly",name:"Libya"},{code:"li",name:"Liechtenstein"},{code:"lt",name:"Lithuania"},{code:"lu",name:"Luxembourg"},{code:"mo",name:"Macao"},{code:"mg",name:"Madagascar"},{code:"mw",name:"Malawi"},{code:"my",name:"Malaysia"},{code:"mv",name:"Maldives"},{code:"ml",name:"Mali"},{code:"mt",name:"Malta"},{code:"mh",name:"Marshall Islands"},{code:"mq",name:"Martinique"},{code:"mr",name:"Mauritania"},{code:"mu",name:"Mauritius"},{code:"yt",name:"Mayotte"},{code:"mx",name:"Mexico"},{code:"fm",name:"Micronesia"},{code:"md",name:"Moldova"},{code:"mc",name:"Monaco"},{code:"mn",name:"Mongolia"},{code:"me",name:"Montenegro"},{code:"ms",name:"Montserrat"},{code:"ma",name:"Morocco"},{code:"mz",name:"Mozambique"},{code:"mm",name:"Myanmar"},{code:"na",name:"Namibia"},{code:"nr",name:"Nauru"},{code:"np",name:"Nepal"},{code:"nl",name:"Netherlands"},{code:"nc",name:"New Caledonia"},{code:"nz",name:"New Zealand"},{code:"ni",name:"Nicaragua"},{code:"ne",name:"Niger"},{code:"ng",name:"Nigeria"},{code:"nu",name:"Niue"},{code:"nf",name:"Norfolk Island"},{code:"mk",name:"North Macedonia"},{code:"mp",name:"N. Mariana Is."},{code:"no",name:"Norway"},{code:"om",name:"Oman"},{code:"pk",name:"Pakistan"},{code:"pw",name:"Palau"},{code:"ps",name:"Palestine"},{code:"pa",name:"Panama"},{code:"pg",name:"Papua New Guinea"},{code:"py",name:"Paraguay"},{code:"pe",name:"Peru"},{code:"ph",name:"Philippines"},{code:"pn",name:"Pitcairn"},{code:"pl",name:"Poland"},{code:"pt",name:"Portugal"},{code:"pr",name:"Puerto Rico"},{code:"qa",name:"Qatar"},{code:"re",name:"R√©union"},{code:"ro",name:"Romania"},{code:"ru",name:"Russia"},{code:"rw",name:"Rwanda"},{code:"bl",name:"St. Barth√©lemy"},{code:"sh",name:"St. Helena"},{code:"kn",name:"St. Kitts & Nevis"},{code:"lc",name:"St. Lucia"},{code:"mf",name:"St. Martin"},{code:"pm",name:"St. Pierre & Miq."},{code:"vc",name:"St. Vincent & Gren."}, {code:"ws",name:"Samoa"},{code:"sm",name:"San Marino"},{code:"st",name:"S√£o Tom√© & Pr√≠ncipe"},{code:"sa",name:"Saudi Arabia"},{code:"sn",name:"Senegal"},{code:"rs",name:"Serbia"},{code:"sc",name:"Seychelles"},{code:"sl",name:"Sierra Leone"},{code:"sg",name:"Singapore"},{code:"sx",name:"Sint Maarten"},{code:"sk",name:"Slovakia"},{code:"si",name:"Slovenia"},{code:"sb",name:"Solomon Islands"},{code:"so",name:"Somalia"},{code:"za",name:"South Africa"},{code:"gs",name:"S. Geo. & S. Sand."}, {code:"ss",name:"South Sudan"},{code:"es",name:"Spain"},{code:"lk",name:"Sri Lanka"},{code:"sd",name:"Sudan"},{code:"sr",name:"Suriname"},{code:"sj",name:"Svalbard & Jan Mayen"},{code:"se",name:"Sweden"},{code:"ch",name:"Switzerland"},{code:"sy",name:"Syria"},{code:"tw",name:"Taiwan"},{code:"tj",name:"Tajikistan"},{code:"tz",name:"Tanzania"},{code:"th",name:"Thailand"},{code:"tl",name:"Timor-Leste"},{code:"tg",name:"Togo"},{code:"tk",name:"Tokelau"},{code:"to",name:"Tonga"},{code:"tt",name:"Trinidad & Tobago"},{code:"tn",name:"Tunisia"},{code:"tr",name:"Turkey"},{code:"tm",name:"Turkmenistan"},{code:"tc",name:"Turks & Caicos"},{code:"tv",name:"Tuvalu"},{code:"ug",name:"Uganda"},{code:"ua",name:"Ukraine"},{code:"ae",name:"UAE"},{code:"gb",name:"United Kingdom"},{code:"us",name:"United States"},{code:"uy",name:"Uruguay"},{code:"uz",name:"Uzbekistan"},{code:"vu",name:"Vanuatu"},{code:"ve",name:"Venezuela"},{code:"vn",name:"Vietnam"},{code:"wf",name:"Wallis & Futuna"},{code:"eh",name:"Western Sahara"},{code:"ye",name:"Yemen"},{code:"zm",name:"Zambia"},{code:"zw",name:"Zimbabwe"}]; const track = document.getElementById("flagsTrack"); const all = [...countries, ...countries]; let activeFlag = null; all.forEach(c => { const div = document.createElement("div"); div.className = "flag"; div.innerHTML = `<img src="https://flagcdn.com/w80/${c.code}.png" alt="${c.name}"><span>${c.name}</span>`; track.appendChild(div); div.addEventListener("mouseenter", () => { track.classList.add("paused"); div.classList.add("show"); }); div.addEventListener("mouseleave", () => { if(activeFlag===null){ track.classList.remove("paused"); div.classList.remove("show"); } }); div.addEventListener("pointerdown", () => { if(/Mobi|Android/i.test(navigator.userAgent)){ if(activeFlag && activeFlag!==div) return; const isActive = div.classList.contains("show"); if(isActive){ div.classList.remove("show"); track.classList.remove("paused"); activeFlag=null; } else { div.classList.add("show"); track.classList.add("paused"); activeFlag=div; } } }); }); function updateTime(zone, timeId, dateId){ const now = new Date(); document.getElementById(timeId).textContent = now.toLocaleTimeString("en-GB",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true,timeZone:zone}); document.getElementById(dateId).textContent = now.toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric",timeZone:zone}); } setInterval(()=>{ updateTime("Europe/London","time-uk","date-uk"); updateTime("Asia/Karachi","time-pk","date-pk"); },1000); function loadWeather(lat,lon,elId,label){ fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(res=>res.json()).then(data=>{ const temp=Math.round(data.current_weather.temperature); const code=data.current_weather.weathercode; let icon="‚òÄÔ∏è"; if([1,2,3].includes(code)) icon="‚õÖ"; if([45,48].includes(code)) icon="üå´Ô∏è"; if([51,53,55,61,63,65,80].includes(code)) icon="üåßÔ∏è"; if([71,73,75,85].includes(code)) icon="‚ùÑÔ∏è"; if([95,96,99].includes(code)) icon="‚õàÔ∏è"; document.getElementById(elId).textContent=`${label} ${icon} ${temp}¬∞C`; }); } loadWeather(52.57,-1.82,"weather-uk","Birmingham"); loadWeather(33.69,73.06,"weather-pk","Islamabad");
    
    /* FIREBASE & CHAT LOGIC - UNTOUCHED */
    const firebaseConfig = { apiKey: "AIzaSyBWwSAuseEPvBoFiPHaZoFNiLV6xhBSeAJI", authDomain: "abdulrafaychat.firebaseapp.com", projectId: "abdulrafaychat", storageBucket: "abdulrafaychat.firebasestorage.app", messagingSenderId: "1078346470566", appId: "1:1078346470566:web:489a0d85d89216e5e39067", databaseURL: "https://abdulrafaychat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const storage = firebase.storage();
    
    let currentUserName = ""; let isInitialLoad = true; let mediaRecorder; let audioChunks = []; let stagedFile = null; let stagedVoiceBlob = null; const MAX_FILE_SIZE_MB = 50;
    let editingMessageKey = null;

    /* DUAL BULLETPROOF EMAIL NOTIFICATION */
    function sendDualAlert(name) {
       const subject = `${name} just joined the Chatroom!`;
       const msg = `${name} has logged into the chat adventure. Time: ${new Date().toLocaleString()}`;
       
       // Create hidden iframe if it doesn't exist
       let iframe = document.getElementById('hidden_iframe'); 
       if (!iframe) { 
           iframe = document.createElement('iframe'); 
           iframe.id = 'hidden_iframe'; 
           iframe.name = 'hidden_iframe'; 
           iframe.style.display = 'none'; 
           document.body.appendChild(iframe); 
       }

       // 1. Primary Attempt: FormSubmit (Hidden Form to bypass CORS)
       const fsForm = document.createElement('form');
       fsForm.method = 'POST'; 
       fsForm.target = 'hidden_iframe';
       fsForm.action = 'https://formsubmit.co/adbrain@gmail.com';
       
       const fsData = { 'Name': name, 'Message': msg, '_subject': subject, '_captcha': 'false' };
       for (const k in fsData) { 
           const i = document.createElement('input'); i.type='hidden'; i.name=k; i.value=fsData[k]; fsForm.appendChild(i); 
       }
       document.body.appendChild(fsForm);
       fsForm.submit();
       setTimeout(() => document.body.removeChild(fsForm), 3000);

       // 2. Secondary Attempt: Web3Forms (AJAX)
       const WEB3_KEY = "af13a3a2-e6db-46cb-b7c4-ce71875cdd94"; 
       fetch("https://api.web3forms.com/submit", {
           method: "POST",
           headers: { "Content-Type": "application/json", "Accept": "application/json" },
           body: JSON.stringify({ 
               access_key: WEB3_KEY, 
               name: name, 
               subject: subject, 
               message: msg,
               from_name: "Chatroom Alerts"
           })
       }).catch(err => console.log("Web3Forms local block bypassed on live site."));
    }

    async function startChat() {
       const name = document.getElementById('userName').value.trim();
       if (!name) return alert("Please enter a name");
       currentUserName = name;
       
       sendDualAlert(name); // Fire alerts

       document.getElementById('chatNameSection').style.display = 'none';
       document.getElementById('chatBox').style.display = 'flex';
       document.getElementById('adminDelete').style.display = 'block';
       document.getElementById('onlineStatus').style.display = 'block';
       const onlineRef = db.ref('online_users/' + name); onlineRef.set(true); onlineRef.onDisconnect().remove();
       db.ref('online_users').on('value', (snap) => { const users = snap.val() ? Object.keys(snap.val()) : []; document.getElementById('userList').innerText = users.join(", "); });
       
      db.ref("messages").on("child_added", (snap) => {
         const data = snap.val();
         appendMessage(data.user, data.text, data.user === currentUserName, data.time, snap.key, data.fileUrl, data.fileType, data.seenBy, data.edited);
         if(data.user !== currentUserName) db.ref(`messages/${snap.key}/seenBy/${currentUserName}`).set(new Date().getTime());
         if(!isInitialLoad) document.getElementById('sendSound').play().catch(()=>{});
       });
      db.ref("messages").once("value", () => { isInitialLoad = false; });
    }

    /* REMAINING FUNCTIONS (Staging, Messaging, Recording) - UNTOUCHED */
    function stageFile(input) {
       const file = input.files[0];
       if (!file) return;
       if (file.size / (1024 * 1024) > MAX_FILE_SIZE_MB) return alert(`Limit is ${MAX_FILE_SIZE_MB}MB`);
       stagedFile = file; stagedVoiceBlob = null;
       renderStagingArea();
    }

    async function toggleRecording() {
       const btn = document.getElementById('voiceBtn');
       const input = document.getElementById('chatInput');
       if (!mediaRecorder || mediaRecorder.state === "inactive") {
         try {
           const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
           mediaRecorder = new MediaRecorder(stream);
           audioChunks = [];
           mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
           mediaRecorder.onstop = () => {
             stagedVoiceBlob = new Blob(audioChunks, { type: 'audio/webm' });
             stagedFile = null;
             renderStagingArea();
             btn.classList.remove('recording-active');
             input.disabled = false;
           };
           mediaRecorder.start();
           btn.classList.add('recording-active');
           input.placeholder = "Speak now...";
           input.disabled = true;
         } catch(e) { alert("Mic access denied."); }
       } else { mediaRecorder.stop(); }
    }

    function renderStagingArea() {
        const area = document.getElementById('stagingArea');
        const contentDiv = document.getElementById('stagingContent');
        const input = document.getElementById('chatInput');
        if (!stagedFile && !stagedVoiceBlob) {
            area.style.display = "none";
            input.placeholder = "Type a message...";
            return;
        }
        area.style.display = "flex";
        input.placeholder = "Click Send now";
        if (stagedFile) {
            let iconHtml = '';
            if (stagedFile.type.startsWith('image/')) {
                const url = URL.createObjectURL(stagedFile);
                iconHtml = `<img src="${url}" class="staging-preview-img">`;
            } else { iconHtml = `<div class="staging-icon">üìÑ</div>`; }
            contentDiv.innerHTML = `${iconHtml} <span>${stagedFile.name}</span>`;
        } else if (stagedVoiceBlob) {
            contentDiv.innerHTML = `<div class="staging-icon">üé§</div> <span>Voice Message Recorded</span>`;
        }
    }

    function clearStaged() { stagedFile = null; stagedVoiceBlob = null; document.getElementById('fileInput').value = ""; renderStagingArea(); }

    function handleSendClick() { if(editingMessageKey) { updateMessage(); } else { sendMessage(); } }

    async function sendMessage() {
       const input = document.getElementById('chatInput');
       const text = input.value.trim();
       if (!text && !stagedFile && !stagedVoiceBlob) return;
       let fileUrl = null; let fileType = null;
       if(stagedFile || stagedVoiceBlob) {
         document.getElementById('uploadSpinner').style.display = 'flex';
         const blob = stagedFile || stagedVoiceBlob;
         const ext = stagedFile ? stagedFile.name.split('.').pop() : 'webm';
         const name = `chat_${Date.now()}.${ext}`;
         try {
           const snap = await storage.ref(`chat_files/${name}`).put(blob);
           fileUrl = await snap.ref.getDownloadURL();
           fileType = stagedFile ? (stagedFile.type.startsWith("image/") ? "image" : "doc") : "voice";
         } catch(e) {
           document.getElementById('uploadSpinner').style.display = 'none';
           return alert("Upload failed.");
         }
       }
       let messageText = text || (stagedVoiceBlob ? "Voice Message" : (stagedFile ? stagedFile.name : ""));
       db.ref("messages").push().set({ user: currentUserName, text: messageText, time: new Date().getTime(), fileUrl: fileUrl, fileType: fileType });
       document.getElementById('uploadSpinner').style.display = 'none';
       input.value = ""; clearStaged();
    }

    function enterEditMode(key, currentText) {
        if (stagedFile || stagedVoiceBlob) return;
        editingMessageKey = key;
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        input.value = currentText; input.focus();
        sendBtn.innerText = "Update"; sendBtn.style.background = "#28a745";
    }

    function updateMessage() {
        const input = document.getElementById('chatInput');
        const newText = input.value.trim();
        if(!newText) return cancelEdit();
        db.ref(`messages/${editingMessageKey}`).update({ text: newText, edited: true });
        cancelEdit();
    }

    function cancelEdit() {
        editingMessageKey = null;
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        input.value = ""; sendBtn.innerText = "Send"; sendBtn.style.background = "";
    }

    function appendMessage(user, text, isMe, time, key, fileUrl, fileType, seenBy, edited) {
       let fullTimeStr = "";
       if(time) { const date = new Date(time); fullTimeStr = date.toLocaleDateString([], { day:'numeric', month:'short' }) + " " + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); }
       const div = document.createElement('div');
       div.className = isMe ? 'msg me' : 'msg';
       div.setAttribute('data-key', key);
       if(isMe && !fileUrl) { div.addEventListener('dblclick', () => enterEditMode(key, text)); }
       let mediaHtml = "";
       if(fileUrl) {
         if(fileType === "image") mediaHtml = `<img src="${fileUrl}" class="chat-img" onclick="window.open('${fileUrl}')">`;
         else if(fileType === "voice") mediaHtml = `<div class="voice-msg"><audio controls src="${fileUrl}"></audio></div>`;
         else mediaHtml = `<a href="${fileUrl}" target="_blank" class="doc-link">üìÑ Download File</a>`;
       }
       div.innerHTML = `<strong>${user}</strong><br><span class="msg-text">${mediaHtml}<br><span class="msg-text-content">${text}</span></span>
                        ${edited ? '<span class="edited-tag">(edited)</span>' : ''}
                        <span class="ts">${fullTimeStr}</span><span class="seen-list"></span>`;
       const box = document.getElementById('messages'); box.appendChild(div); box.scrollTop = box.scrollHeight;
       updateSeenDisplay(div, {user, seenBy});
    }

    function updateSeenDisplay(element, data) { const seenList = element.querySelector('.seen-list'); if(currentUserName === "Adnan" && data.user === "Adnan" && data.seenBy) { const names = Object.keys(data.seenBy).filter(n => n !== "Adnan").map(n => { const time = new Date(data.seenBy[n]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); return `${n} (${time})`; }); if(names.length > 0) seenList.innerHTML = `<span class="seen-indicator">Seen by: ${names.join(", ")}</span>`; } }
    function pressEmoji(emoji) { const i = document.getElementById('chatInput'); i.value += emoji; }
  </script>
</body>
</html>