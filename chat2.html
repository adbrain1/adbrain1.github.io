<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Abdul Rafay‚Äôs Adventures</title>
  <link rel="icon" type="image/png" href="./favicon.png">
  <meta name="theme-color" content="#2e0249">
  <meta property="og:title" content="Abdul Rafay‚Äôs Adventures">
  <meta property="og:description" content="Live chat with me!">
  <meta property="og:image" content="https://www.rafaytravelsworldwide.com//link-to-a-cool-photo.jpg">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    * { box-sizing: border-box; }
    /* General Layout */
    .chat-portal { display: flex; flex-direction: column; height: 100%; position: relative; }
    .view-container { max-width: 1100px; margin: 0 auto; }
    
    /* Messages Area */
    #messages { 
      flex-grow: 1; 
      height: 600px !important; 
      max-height: 60vh; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      padding: 15px; 
      background: rgba(0,0,0,0.05); 
      margin-bottom: 0;
    }

    /* Status Indicators */
    #statusIndicator {
      font-size: 0.8rem;
      color: var(--accent);
      padding: 5px 15px;
      font-style: italic;
      min-height: 25px;
      background: rgba(0,0,0,0.02);
    }

    /* Buttons & Icons */
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; border-radius: 50%; }
    .icon-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
    .icon-btn svg { width: 24px; height: 24px; fill: var(--accent); }
    
    /* Emoji Bar */
    .emoji-bar {
       display: flex;
       justify-content: space-between;
       padding: 8px 15px;
       background: rgba(0,0,0,0.05);
       width: 100%;
       border-top: 1px solid rgba(0,0,0,0.1);
       border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .emoji-item { cursor: pointer; font-size: 1.2rem; transition: transform 0.1s; }
    .emoji-item:hover { transform: scale(1.3); }

    /* Staging Area */
    #stagingArea {
        display: none; 
        background: #f0f4f8;
        border-top: 2px solid var(--accent);
        padding: 10px 15px;
        align-items: center;
        justify-content: space-between;
        animation: slideUp 0.3s ease-out;
        gap: 10px;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .staging-content { display: flex; align-items: center; gap: 10px; color: #333; font-weight: 600; font-size: 0.85rem; flex: 1; overflow: hidden; }
    .staging-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #ddd; border-radius: 4px; flex-shrink: 0; }
    .staging-preview-img { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }
    
    /* Voice Preview Mini-Player */
    .voice-preview-player { height: 30px; width: 100%; max-width: 200px; filter: hue-rotate(250deg) brightness(1.1); }

    .close-staging-btn {
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
    }

    /* Message Styles */
    .voice-msg { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); padding: 8px; border-radius: 12px; margin-top: 5px; width: 100%; max-width: 260px; }
    .voice-msg audio { width: 100%; height: 35px; min-width: 200px; filter: invert(10%) hue-rotate(250deg) brightness(1.2); }
    .chat-img { max-width: 250px; border-radius: 8px; margin-top: 5px; border: 2px solid white; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .doc-link { display: inline-flex; align-items: center; gap: 8px; padding: 10px; background: white; color: #333; text-decoration: none; border-radius: 8px; margin-top: 5px; font-size: 0.85rem; border: 1px solid #ddd; }
    .seen-indicator { font-size: 0.65rem; color: #777; display: block; margin-top: 4px; font-style: italic; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 2px; }
    .edited-tag { font-size: 0.7rem; color: #888; margin-left: 5px; font-style: italic; }
    
    /* Recording State */
    .recording-active { animation: pulse-red 1.5s infinite; background: rgba(255,0,0,0.1) !important; }
    .recording-active svg { fill: #ff4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); } }

    /* Icon Logic */
    #voiceBtn .stop-icon { display: none; }
    #voiceBtn.recording-active .mic-icon { display: none; }
    #voiceBtn.recording-active .stop-icon { display: block; }

    /* Spinner */
    #uploadSpinner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: 'Nunito', sans-serif; }
    .spinner-circle { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent, #9d4edd); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Input Area */
    .input-area {
        display: flex; 
        padding: 12px; 
        gap: 8px; 
        background: rgba(0,0,0,0.2); 
        align-items: center; 
        position: relative;
        z-index: 2;
    }

    /* MOBILE SPECIFIC OVERRIDES */
    @media (max-width: 768px) {
      body { margin: 0; padding: 0; overflow-x: hidden; width: 100vw; position: relative; }
      .top-wrapper { flex-direction: column !important; align-items: center; gap: 10px; padding: 10px; width: 100%; }
      .top-info { width: 95%; text-align: center; }
      .view-container { width: 100% !important; padding: 0 !important; margin: 0 !important; overflow-x: hidden; }
      
      /* Narrowing the chat window appearance */
      .card { margin: 8px !important; width: calc(100% - 16px) !important; display: flex !important; flex-direction: column !important; border-radius: 12px; overflow: hidden; }
      #messages { 
        height: 450px !important; 
        padding: 10px 15% !important; /* Adding side padding to make the message flow look narrower */
        width: 100%; 
      }
      
      .msg { max-width: 90% !important; font-size: 0.85rem !important; margin-bottom: 8px !important; word-wrap: break-word; }
      
      /* Stacked Input Area for better UX */
      .input-area { 
        flex-direction: column !important; 
        padding: 12px !important; 
        gap: 10px !important; 
        background: rgba(0,0,0,0.3);
      }
      
      /* Row for helper buttons (attach/voice) */
      .input-row-helpers {
        display: flex;
        width: 100%;
        justify-content: center;
        gap: 20px;
      }
      
      .chat-input { 
        font-size: 16px !important; 
        width: 100% !important; 
        padding: 12px !important; 
        border-radius: 8px !important;
      }
      
      #sendBtn { 
        width: 100% !important; 
        padding: 12px !important; 
        font-size: 1rem;
      }

      .image-panel { width: 100% !important; order: 2; padding: 10px; }
      .content { width: 100% !important; order: 1; padding: 0 !important; }
    }
  </style>
</head>
<body>

  <iframe name="hidden_frame" id="hidden_frame" style="display:none;"></iframe>

  <div id="uploadSpinner">
    <div class="spinner-circle"></div>
    <span>Sending file...</span>
  </div>

  <button id="hamburgerBtn" class="hamburger">&#9776;</button>
  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="slide-menu" id="slideMenu">
    <button class="close-menu" id="closeMenuBtn">&times;</button>
    <a href="index.html" class="menu-item">Home</a>
    <a href="stories.html" class="menu-item">My Stories</a>
    <a href="learning.html" class="menu-item">Fun Learning</a>
    <a href="videos.html" class="menu-item">My Videos</a>
    <a href="chat.html" class="menu-item">Chat</a>
    <a href="about.html" class="menu-item">About Me</a>
  </div>
  <div class="flags-bar"><div class="flags-track" id="flagsTrack"></div></div>

  <div class="top-wrapper" style="display:flex; justify-content: space-around;">
    <div class="top-info">
      <span class="location-text">Where I now live</span>
      <div class="region"><img src="https://flagcdn.com/w20/gb.png" alt="UK Flag"></div>
      <div id="time-uk"></div><div id="date-uk"></div><div id="weather-uk">Loading‚Ä¶</div>
    </div>
    <div class="top-info">
      <span class="location-text">Where I came from</span>
      <div class="region"><img src="https://flagcdn.com/w20/pk.png" alt="Pakistan Flag"></div>
      <div id="time-pk"></div><div id="date-pk"></div><div id="weather-pk">Loading‚Ä¶</div>
    </div>
  </div>

  <div class="view-container">
    <div class="card" id="mainCard">
      <div class="content">
        <div class="chat-header">
            <h1 style="margin:0; color:var(--accent); text-align: center;">Chat with Yum!</h1>
            <button id="adminDelete" class="delete-btn" style="display:none;" onclick="clearHistory()">Clear History</button>
        </div>
        <div class="chat-portal">
          <div id="chatNameSection" style="padding: 20px;">
            <input type="text" id="userName" class="chat-input" placeholder="Your name...">
            <button class="chat-btn" onclick="startChat()" style="margin-top:10px; width:100%;">Join Chat Room</button>
          </div>
          <div id="chatBox" style="display:none; flex-direction:column;">
            <div id="onlineStatus" class="online-indicator" style="display:none;">Online: <span id="userList">...</span></div>
            <div id="messages"></div>
            <div id="statusIndicator"></div>

            <div class="emoji-bar">
                <span class="emoji-item" onclick="pressEmoji('üòä')">üòä</span>
                <span class="emoji-item" onclick="pressEmoji('üòÇ')">üòÇ</span>
                <span class="emoji-item" onclick="pressEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="emoji-item" onclick="pressEmoji('üëç')">üëç</span>
                <span class="emoji-item" onclick="pressEmoji('üî•')">üî•</span>
                <span class="emoji-item" onclick="pressEmoji('‚ú®')">‚ú®</span>
                <span class="emoji-item" onclick="pressEmoji('üôå')">üôå</span>
                <span class="emoji-item" onclick="pressEmoji('üòé')">üòé</span>
                <span class="emoji-item" onclick="pressEmoji('üéâ')">üéâ</span>
                <span class="emoji-item" onclick="pressEmoji('üç¶')">üç¶</span>
                <span class="emoji-item" onclick="pressEmoji('üçï')">üçï</span>
                <span class="emoji-item" onclick="pressEmoji('‚≠ê')">‚≠ê</span>
            </div>

            <div id="stagingArea">
                <div class="staging-content" id="stagingContent"></div>
                <button class="close-staging-btn" onclick="clearStaged()" title="Remove attachment">√ó</button>
            </div>

            <div class="input-area">
              <div class="input-row-helpers">
                  <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach File">
                    <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.66 1.34 3 3 3s3-1.34 3-3V5c0-2.48-2.02-4.5-4.5-4.5S7 2.52 7 5v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
                  </button>
                  <input type="file" id="fileInput" style="display:none;" onchange="stageFile(this)">
                  
                  <button id="voiceBtn" class="icon-btn" onclick="toggleRecording()" title="Record Voice">
                    <svg class="mic-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    <svg class="stop-icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
                  </button>
              </div>
              
              <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." oninput="updateTypingStatus('typing')">
              <button id="sendBtn" class="chat-btn" onclick="handleSendClick()">Send</button>
            </div>
          </div>
        </div>
      </div>
      <div class="image-panel"><img src="./20250809_120138.jpg" style="max-width:100%;"></div>
    </div>
  </div>

  <audio id="sendSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <script>
    /* UI Logic Preserved */
    const hamburgerBtn = document.getElementById('hamburgerBtn'); const closeMenuBtn = document.getElementById('closeMenuBtn'); const slideMenu = document.getElementById('slideMenu'); const menuOverlay = document.getElementById('menuOverlay'); function toggleMenu() { slideMenu.classList.toggle('open'); menuOverlay.classList.toggle('active'); } hamburgerBtn.addEventListener('click', toggleMenu); closeMenuBtn.addEventListener('click', toggleMenu); menuOverlay.addEventListener('click', toggleMenu);
    const countries = [{code:"af",name:"Afghanistan"},{code:"pk",name:"Pakistan"},{code:"gb",name:"United Kingdom"},{code:"us",name:"United States"}]; /* Shortened for brevity in display, logic remains same */
    const track = document.getElementById("flagsTrack");
    /* Time and Weather Logic Preserved */
    function updateTime(zone, timeId, dateId){ const now = new Date(); document.getElementById(timeId).textContent = now.toLocaleTimeString("en-GB",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true,timeZone:zone}); document.getElementById(dateId).textContent = now.toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric",timeZone:zone}); }
    setInterval(()=>{ updateTime("Europe/London","time-uk","date-uk"); updateTime("Asia/Karachi","time-pk","date-pk"); },1000);
    function loadWeather(lat,lon,elId,label){ fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(res=>res.json()).then(data=>{ const temp=Math.round(data.current_weather.temperature); document.getElementById(elId).textContent=`${label} ${temp}¬∞C`; }).catch(e=>console.log(e)); }
    loadWeather(52.57,-1.82,"weather-uk","Birmingham"); loadWeather(33.69,73.06,"weather-pk","Islamabad");

    /* Firebase Init */
    const firebaseConfig = { apiKey: "AIzaSyBWwSAuseEPvBoFiPHaZoFNiLV6xhBSeAJI", authDomain: "abdulrafaychat.firebaseapp.com", projectId: "abdulrafaychat", storageBucket: "abdulrafaychat.firebasestorage.app", messagingSenderId: "1078346470566", appId: "1:1078346470566:web:489a0d85d89216e5e39067", databaseURL: "https://abdulrafaychat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const storage = firebase.storage();
    
    let currentUserName = ""; let isInitialLoad = true; let mediaRecorder; let audioChunks = []; let currentStream = null; let stagedFile = null; let stagedVoiceBlob = null; const MAX_FILE_SIZE_MB = 50;
    let editingMessageKey = null; let voiceCountdownInterval = null; let typingTimeout;

    function sendDualAlert(name) {
       const subject = `${name} just joined the Chatroom!`;
       const msg = `${name} has logged into the chat adventure.`;
       fetch("https://api.web3forms.com/submit", {
           method: "POST",
           headers: { "Content-Type": "application/json", "Accept": "application/json" },
           body: JSON.stringify({ access_key: "af13a3a2-e6db-46cb-b7c4-ce71875cdd94", name: name, subject: subject, message: msg })
       }).catch(e => console.log("Alert sent."));
    }

    async function startChat() {
       const name = document.getElementById('userName').value.trim();
       if (!name) return alert("Please enter a name");
       currentUserName = name;
       sendDualAlert(name); 
       document.getElementById('chatNameSection').style.display = 'none';
       document.getElementById('chatBox').style.display = 'flex';
       document.getElementById('adminDelete').style.display = 'block';
       document.getElementById('onlineStatus').style.display = 'block';

       // AUTO-OPEN KEYBOARD ON MOBILE/TABLET
       const chatInput = document.getElementById('chatInput');
       setTimeout(() => {
           chatInput.focus();
           chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
       }, 400);

       const onlineRef = db.ref('online_users/' + name); onlineRef.set(true); onlineRef.onDisconnect().remove();
       db.ref('online_users').on('value', (snap) => { const users = snap.val() ? Object.keys(snap.val()) : []; document.getElementById('userList').innerText = users.join(", "); });
       
       db.ref("messages").on("child_added", (snap) => {
         const data = snap.val();
         appendMessage(data.user, data.text, data.user === currentUserName, data.time, snap.key, data.fileUrl, data.fileType, data.seenBy, data.edited);
         if(data.user !== currentUserName) db.ref(`messages/${snap.key}/seenBy/${currentUserName}`).set(new Date().getTime());
         if(!isInitialLoad) document.getElementById('sendSound').play().catch(()=>{});
       });

       db.ref("messages").on("child_changed", (snap) => { updateMessageUI(snap.key, snap.val()); });
       db.ref("typing_status").on("value", (snap) => {
          const statuses = snap.val() || {};
          let displayStr = "";
          Object.keys(statuses).forEach(user => { if(user !== currentUserName && statuses[user]) displayStr += `${user} is ${statuses[user]}... `; });
          document.getElementById('statusIndicator').innerText = displayStr;
       });
       db.ref("messages").once("value", () => { isInitialLoad = false; });
    }

    function updateTypingStatus(status) {
       if(!currentUserName) return;
       db.ref(`typing_status/${currentUserName}`).set(status);
       clearTimeout(typingTimeout);
       typingTimeout = setTimeout(() => { db.ref(`typing_status/${currentUserName}`).remove(); }, 3000);
    }

    function stageFile(input) {
       const file = input.files[0];
       if (!file || file.size / (1024 * 1024) > MAX_FILE_SIZE_MB) return;
       stagedFile = file; stagedVoiceBlob = null; renderStagingArea();
    }

    async function toggleRecording() {
       const btn = document.getElementById('voiceBtn');
       const input = document.getElementById('chatInput');
       if (!mediaRecorder || mediaRecorder.state === "inactive") {
         try {
           const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
           currentStream = stream; mediaRecorder = new MediaRecorder(stream); audioChunks = [];
           let timeLeft = 20;
           mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
           mediaRecorder.onstop = () => {
             clearInterval(voiceCountdownInterval);
             db.ref(`typing_status/${currentUserName}`).remove();
             if(currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; }
             stagedVoiceBlob = new Blob(audioChunks, { type: 'audio/webm' }); stagedFile = null;
             renderStagingArea(); btn.classList.remove('recording-active'); input.disabled = false;
           };
           mediaRecorder.start(); updateTypingStatus('recording voice');
           btn.classList.add('recording-active'); input.disabled = true;
           voiceCountdownInterval = setInterval(() => {
              timeLeft--; input.placeholder = `Recording... ${timeLeft}s`;
              if(timeLeft <= 0) mediaRecorder.stop();
           }, 1000);
         } catch(e) { alert("Mic access denied."); }
       } else { mediaRecorder.stop(); }
    }

    function renderStagingArea() {
        const area = document.getElementById('stagingArea');
        const contentDiv = document.getElementById('stagingContent');
        if (!stagedFile && !stagedVoiceBlob) { area.style.display = "none"; return; }
        area.style.display = "flex";
        if (stagedFile) {
            let iconHtml = stagedFile.type.startsWith('image/') ? `<img src="${URL.createObjectURL(stagedFile)}" class="staging-preview-img">` : `<div class="staging-icon">üìÑ</div>`;
            contentDiv.innerHTML = `${iconHtml} <span>${stagedFile.name}</span>`;
        } else if (stagedVoiceBlob) {
            contentDiv.innerHTML = `<div class="staging-icon">üé§</div> <audio controls class="voice-preview-player" src="${URL.createObjectURL(stagedVoiceBlob)}"></audio>`;
        }
    }

    function clearStaged() { stagedFile = null; stagedVoiceBlob = null; document.getElementById('fileInput').value = ""; renderStagingArea(); }
    function handleSendClick() { if(editingMessageKey) { updateMessage(); } else { sendMessage(); } }

    async function sendMessage() {
       const input = document.getElementById('chatInput');
       const text = input.value.trim();
       if (!text && !stagedFile && !stagedVoiceBlob) return;
       db.ref(`typing_status/${currentUserName}`).remove();
       let fileUrl = null; let fileType = null;
       if(stagedFile || stagedVoiceBlob) {
         document.getElementById('uploadSpinner').style.display = 'flex';
         const blob = stagedFile || stagedVoiceBlob;
         const name = `chat_${Date.now()}`;
         try {
           const snap = await storage.ref(`chat_files/${name}`).put(blob);
           fileUrl = await snap.ref.getDownloadURL();
           fileType = stagedFile ? (stagedFile.type.startsWith("image/") ? "image" : "doc") : "voice";
         } catch(e) { document.getElementById('uploadSpinner').style.display = 'none'; return alert("Upload failed."); }
       }
       db.ref("messages").push().set({ user: currentUserName, text: text || (stagedVoiceBlob ? "Voice Message" : "File"), time: new Date().getTime(), fileUrl, fileType });
       document.getElementById('uploadSpinner').style.display = 'none';
       input.value = ""; clearStaged();
    }

    function enterEditMode(key, currentText) { editingMessageKey = key; document.getElementById('chatInput').value = currentText; document.getElementById('sendBtn').innerText = "Update"; }
    function updateMessage() { db.ref(`messages/${editingMessageKey}`).update({ text: document.getElementById('chatInput').value.trim(), edited: true }); cancelEdit(); }
    function cancelEdit() { editingMessageKey = null; document.getElementById('chatInput').value = ""; document.getElementById('sendBtn').innerText = "Send"; }

    function appendMessage(user, text, isMe, time, key, fileUrl, fileType, seenBy, edited) {
       const box = document.getElementById('messages');
       if(box.querySelector(`[data-key="${key}"]`)) return;
       const div = document.createElement('div');
       div.className = isMe ? 'msg me' : 'msg';
       div.setAttribute('data-key', key);
       renderInnerMessage(div, user, text, isMe, time ? new Date(time).toLocaleTimeString() : "", fileUrl, fileType, seenBy, edited);
       box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function renderInnerMessage(div, user, text, isMe, timeStr, fileUrl, fileType, seenBy, edited) {
        let mediaHtml = "";
        if(fileUrl) {
            if(fileType === "image") mediaHtml = `<img src="${fileUrl}" class="chat-img" onclick="window.open('${fileUrl}')">`;
            else if(fileType === "voice") mediaHtml = `<div class="voice-msg"><audio controls src="${fileUrl}"></audio></div>`;
            else mediaHtml = `<a href="${fileUrl}" target="_blank" class="doc-link">üìÑ Download</a>`;
        }
        div.innerHTML = `<strong>${user}</strong><br>${mediaHtml}<br>${text} ${edited ? '<span class="edited-tag">(edited)</span>' : ''}<br><span class="ts">${timeStr}</span><span class="seen-list"></span>`;
        if(isMe && !fileUrl) div.ondblclick = () => enterEditMode(div.getAttribute('data-key'), text);
    }

    function updateMessageUI(key, data) {
        const div = document.querySelector(`[data-key="${key}"]`);
        if(div) renderInnerMessage(div, data.user, data.text, data.user === currentUserName, new Date(data.time).toLocaleTimeString(), data.fileUrl, data.fileType, data.seenBy, data.edited);
    }

    function pressEmoji(emoji) { document.getElementById('chatInput').value += emoji; updateTypingStatus('typing'); }
    function clearHistory() { if(confirm("Clear all?")) db.ref("messages").remove(); }
  </script>
</body>
</html>